<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Pro - v50 Impacto Global por Sexo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .tab-active { border-bottom: 4px solid #2563eb; color: #1e40af; background-color: #eff6ff; font-weight: 800; }
        .tab-inactive { color: #64748b; cursor: pointer; transition: all 0.2s; }
        .group-card { border-left: 4px solid #e2e8f0; transition: all 0.2s; }
        .group-card:hover { border-left-color: #3b82f6; background-color: #f1f5f9; }
        .stat-bar { height: 8px; border-radius: 4px; background-color: #e2e8f0; overflow: hidden; }
        .stat-fill { height: 100%; transition: width 0.5s ease-out; }
        
        /* Tablas profesionales */
        .table-container { overflow-x: auto; border-radius: 1rem; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background-color: #f8fafc; color: #64748b; text-transform: uppercase; font-size: 0.7rem; padding: 1rem; border-bottom: 2px solid #e2e8f0; }
        td { padding: 1rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <!-- CABECERA -->
        <header class="bg-white p-6 rounded-2xl shadow-xl mb-8 border-b-4 border-blue-600 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left">
                <h1 class="text-4xl font-black text-slate-900 tracking-tighter">ANALYTICS <span class="text-blue-600">PRO</span></h1>
                <p class="text-slate-500 font-medium">v50 - Cruce Global de Sexo y Condici√≥n</p>
            </div>
            <div class="flex flex-wrap gap-3 justify-center">
                <input type="file" id="fileInput" class="hidden" accept=".json" onchange="loadBackupFile(this)">
                <button onclick="document.getElementById('fileInput').click()" class="bg-amber-500 hover:bg-amber-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg transition-all active:scale-95">üìÇ Cargar Backup</button>
                <button onclick="downloadBackup()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg transition-all active:scale-95">üíæ Backup</button>
                <button onclick="exportToCSV()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg transition-all active:scale-95">üì• Excel</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- PANEL DE ENTRADA -->
            <div class="lg:col-span-4 space-y-8">
                <!-- GESTOR DE GRUPOS -->
                <section class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="bg-slate-800 p-4 flex justify-between items-center">
                        <h2 class="text-white font-extrabold text-xs uppercase tracking-widest">üë• Grupos de Trabajo</h2>
                    </div>
                    <div class="p-4 space-y-3">
                        <div id="groupList" class="space-y-2"></div>
                        <button onclick="addNewGroup()" class="w-full py-3 bg-slate-50 hover:bg-blue-50 text-slate-600 hover:text-blue-600 rounded-xl text-xs font-black border-2 border-dashed border-slate-200 transition-all">+ NUEVO GRUPO</button>
                    </div>
                </section>

                <!-- FORMULARIO -->
                <section class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="flex border-b">
                        <button onclick="switchTab('PRE')" id="tabPre" class="w-1/2 py-4 font-black transition-all tab-active">PRE-TEST</button>
                        <button onclick="switchTab('POST')" id="tabPost" class="w-1/2 py-4 font-black transition-all tab-inactive">POST-TEST</button>
                    </div>

                    <div class="p-6 text-sm">
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Seleccionar Grupo</label>
                                <select id="inputGrupo" class="w-full border-2 border-slate-100 rounded-xl p-3 bg-slate-50 font-bold focus:border-blue-500 outline-none" onchange="checkGroupType()"></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" id="codigo" class="w-full border-2 border-slate-100 rounded-xl p-3 uppercase font-mono font-bold" placeholder="CODIGO" onblur="checkExistingStudent()">
                                <select id="sexo" class="w-full border-2 border-slate-100 rounded-xl p-3 bg-white font-bold"><option value="M">Masc</option><option value="F">Fem</option></select>
                            </div>
                        </div>

                        <!-- BLOQUES COMUNES -->
                        <div id="sectionPreExp" class="p-4 bg-slate-50 rounded-2xl border border-slate-200 mb-6">
                            <h3 class="text-[10px] font-black text-slate-600 uppercase mb-3">üßò Bloque 0: Experiencia</h3>
                            <select id="exp_si" class="w-full border rounded-lg p-2 text-xs font-bold mb-2"><option value="No">Sin experiencia</option><option value="Si">Con experiencia</option></select>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="exp_freq" class="border rounded-lg p-2 text-[10px]"><option value="">Frecuencia...</option><option value="Pocas">Pocas veces</option><option value="Habitual">Habitual</option></select>
                                <input type="text" id="exp_donde" class="border rounded-lg p-2 text-[10px]" placeholder="¬øD√≥nde?">
                            </div>
                        </div>

                        <div id="sectionPostVal" class="hidden p-4 bg-emerald-50 rounded-2xl border border-emerald-100 mb-6">
                            <h3 class="text-[10px] font-black text-emerald-800 uppercase mb-3">‚≠ê Valoraci√≥n</h3>
                            <div class="space-y-2">
                                <select id="val_ayuda" class="w-full border rounded p-1.5 text-xs"><option value="-">¬øAyuda?</option><option value="Si">S√≠</option><option value="No">No</option></select>
                                <input type="number" id="val_sentido" min="1" max="5" class="w-full border rounded p-1.5 text-xs" placeholder="Sensaci√≥n (1-5)">
                                <select id="val_foco" class="w-full border rounded p-1.5 text-xs"><option value="-">¬øConcentraci√≥n?</option><option value="Si">S√≠</option><option value="No">No</option></select>
                                <select id="val_repetir" class="w-full border rounded p-1.5 text-xs"><option value="-">¬øRepetir?</option><option value="Si">S√≠</option><option value="No">No</option></select>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                                <h3 class="text-[10px] font-black text-blue-800 uppercase mb-3 text-center">Ansiedad (1-4)</h3>
                                <div class="grid grid-cols-5 gap-2">
                                    <input type="number" id="a1" class="w-full border rounded-lg p-2 text-center" placeholder="1"><input type="number" id="a2" class="w-full border rounded-lg p-2 text-center" placeholder="2"><input type="number" id="a3" class="w-full border rounded-lg p-2 text-center" placeholder="3"><input type="number" id="a4" class="w-full border rounded-lg p-2 text-center" placeholder="4"><input type="number" id="a5" class="w-full border rounded-lg p-2 text-center" placeholder="5">
                                    <input type="number" id="a6" class="w-full border rounded-lg p-2 text-center" placeholder="6"><input type="number" id="a7" class="w-full border rounded-lg p-2 text-center" placeholder="7"><input type="number" id="a8" class="w-full border rounded-lg p-2 text-center" placeholder="8"><input type="number" id="a9" class="w-full border rounded-lg p-2 text-center" placeholder="9"><input type="number" id="a10" class="w-full border rounded-lg p-2 text-center" placeholder="10">
                                </div>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-2xl border border-purple-100">
                                <h3 class="text-[10px] font-black text-purple-800 uppercase mb-3 text-center">Atenci√≥n (1-5)</h3>
                                <div class="grid grid-cols-5 gap-2">
                                    <input type="number" id="at1" class="w-full border rounded-lg p-2 text-center" placeholder="1"><input type="number" id="at2" class="w-full border rounded-lg p-2 text-center" placeholder="2"><input type="number" id="at3" class="w-full border rounded-lg p-2 text-center" placeholder="3"><input type="number" id="at4" class="w-full border rounded-lg p-2 text-center" placeholder="4"><input type="number" id="at5" class="w-full border rounded-lg p-2 text-center" placeholder="5">
                                </div>
                            </div>
                            <textarea id="observaciones" class="w-full border-2 border-slate-100 rounded-2xl p-4 text-xs h-16 bg-slate-50" placeholder="Notas..."></textarea>
                        </div>

                        <div class="mt-8 flex gap-3">
                            <button onclick="saveDataEntry()" class="flex-1 bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl uppercase text-sm">GUARDAR <span id="btnPhaseText">PRE</span></button>
                            <button onclick="clearForm()" class="px-5 bg-slate-100 text-slate-500 rounded-2xl">‚úï</button>
                        </div>
                        <p id="msg" class="text-center text-[11px] font-bold mt-4 h-4"></p>
                    </div>
                </section>
            </div>

            <!-- PANEL DE RESULTADOS -->
            <div class="lg:col-span-8 space-y-12">
                
                <!-- 1. BLOQUE DE RESULTADOS TOTALES -->
                <div class="space-y-6">
                    <h2 class="text-sm font-black text-slate-400 uppercase tracking-[0.2em] text-center italic">1. Resultados Globales Muestra Total</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-indigo-600"><div class="chart-container"><canvas id="chartGlobalAnsiedad"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-indigo-600"><div class="chart-container"><canvas id="chartGlobalAtencion"></canvas></div></div>
                    </div>
                </div>

                <!-- 2. BLOQUE DE RESULTADOS POR SEXO (CRUCE GLOBAL) -->
                <div class="space-y-6">
                    <h2 class="text-sm font-black text-slate-400 uppercase tracking-[0.2em] text-center italic">2. Cruce Global: Sexo y Condici√≥n</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-rose-500">
                            <div class="chart-container"><canvas id="chartGlobalSexAns"></canvas></div>
                            <p class="text-[9px] text-center text-slate-400 mt-2 italic">Segmentaci√≥n Global Ansiedad (STAIC)</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-blue-500">
                            <div class="chart-container"><canvas id="chartGlobalSexAtt"></canvas></div>
                            <p class="text-[9px] text-center text-slate-400 mt-2 italic">Segmentaci√≥n Global Atenci√≥n Percibida</p>
                        </div>
                    </div>
                </div>

                <!-- 3. REPORTES INDIVIDUALES POR AULA -->
                <div class="space-y-6">
                    <h2 class="text-sm font-black text-slate-400 uppercase tracking-[0.2em] text-center italic">3. Informes Detallados por Aula</h2>
                    <div id="dynamicGroupReportsContainer" class="space-y-12"></div>
                </div>

                <!-- 4. VALORACI√ìN CUALITATIVA -->
                <section class="bg-white rounded-2xl shadow-lg border-t-8 border-emerald-500 overflow-hidden">
                    <div class="p-4 bg-emerald-50 border-b flex justify-between items-center">
                        <h2 class="font-black text-emerald-900 text-sm uppercase">Satisfacci√≥n (Muestra Experimental)</h2>
                        <span id="valCount" class="bg-white px-3 py-1 rounded-full text-[10px] font-bold text-emerald-600 shadow-sm">0 respuestas</span>
                    </div>
                    <div id="satisfactionDetails" class="p-6"></div>
                </section>

                <!-- 5. TABLAS DE DATOS -->
                <div id="dynamicTablesContainer" class="space-y-12"></div>

                <!-- 6. OBSERVACIONES -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pb-20">
                    <section class="bg-white rounded-2xl shadow-lg border-t-8 border-amber-400 flex flex-col">
                        <div class="p-4 border-b font-black text-amber-900 text-xs">üìù OBSERVACIONES PRE</div>
                        <div id="obsContainerPre" class="p-4 space-y-3 max-h-80 overflow-y-auto text-xs"></div>
                    </section>
                    <section class="bg-white rounded-2xl shadow-lg border-t-8 border-emerald-400 flex flex-col">
                        <div class="p-4 border-b font-black text-emerald-900 text-xs">üèÅ OBSERVACIONES POST</div>
                        <div id="obsContainerPost" class="p-4 space-y-3 max-h-80 overflow-y-auto text-xs"></div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ESTADO Y CONFIGURACI√ìN ---
        let config = { groups: [{ id: 'g1', name: 'Grupo Experimental', type: 'Experimental' }, { id: 'g2', name: 'Grupo Control', type: 'Control' }] };
        let students = [];
        let currentPhase = 'PRE';
        let charts = { fixed: {}, groups: {} };

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);
            loadData(); renderAll();
        });

        // --- GESTI√ìN DE GRUPOS ---
        function addNewGroup() { const id = 'g' + Date.now(); config.groups.push({ id, name: 'Nuevo Grupo', type: 'Experimental' }); saveData(); renderAll(); }
        function deleteGroup(id) { if (config.groups.length <= 1) return; if (confirm("¬øBorrar grupo?")) { config.groups = config.groups.filter(g => g.id !== id); saveData(); renderAll(); } }
        function updateGroup(id) { const el = document.querySelector(`[data-group-id="${id}"]`); const name = el.querySelector('.gn-input').value; const type = el.querySelector('.gt-select').value; const g = config.groups.find(x => x.id === id); if (g) { g.name = name; g.type = type; saveData(); renderAll(); } }

        // --- L√ìGICA DE DATOS ---
        function saveDataEntry() {
            const code = document.getElementById('codigo').value.toUpperCase().trim();
            const groupId = document.getElementById('inputGrupo').value;
            if (!code) return showMsg("C√≥digo requerido", "text-red-500");
            const rawAns = Array.from({length:10}, (_,i) => parseInt(document.getElementById('a'+(i+1)).value) || 0);
            const rawAtt = Array.from({length:5}, (_,i) => parseInt(document.getElementById('at'+(i+1)).value) || 0);
            const calc = (vals, invIdx, maxVal) => {
                let sum = 0, count = 0;
                vals.forEach((v, i) => { if (v > 0) { count++; sum += invIdx.includes(i) ? (maxVal + 1 - v) : v; } });
                return count > 0 ? parseFloat(((sum / count) * vals.length).toFixed(2)) : 0;
            };
            const ansScore = calc(rawAns, [0,3,5,7,9], 4);
            const attScore = calc(rawAtt, [4], 5);
            let s = students.find(x => x.codigo === code);
            if (!s) {
                s = { codigo: code, groupId, sexo: document.getElementById('sexo').value, pre: null, post: null };
                students.push(s);
            } else if (currentPhase === 'PRE') { s.groupId = groupId; s.sexo = document.getElementById('sexo').value; }
            const obs = document.getElementById('observaciones').value.trim();
            if (currentPhase === 'PRE') {
                s.pre = { ans: ansScore, att: attScore, obs, rawAns, rawAtt, exp: { si: document.getElementById('exp_si').value, freq: document.getElementById('exp_freq').value, donde: document.getElementById('exp_donde').value } };
            } else {
                s.post = { ans: ansScore, att: attScore, obs, rawAns, rawAtt, val: { ayuda: document.getElementById('val_ayuda').value, sentido: parseInt(document.getElementById('val_sentido').value) || 0, foco: document.getElementById('val_foco').value, repetir: document.getElementById('val_repetir').value } };
            }
            saveData(); renderAll(); clearForm(); showMsg("‚úî Guardado", "text-green-600");
        }

        // --- RENDERIZADO DOM ---
        function renderAll() { 
            renderGroups(); 
            renderInputSelect(); 
            renderTables(); 
            renderObservations(); 
            renderSatisfaction(); 
            renderDynamicGroupReports(); 
            initCharts(); 
            updateChartsData(); 
        }

        function renderGroups() {
            const list = document.getElementById('groupList');
            list.innerHTML = config.groups.map(g => `
                <div class="group-card flex items-center gap-2 p-2 bg-slate-50 rounded-xl border border-slate-100" data-group-id="${g.id}">
                    <input type="text" value="${g.name}" class="gn-input flex-1 bg-transparent font-bold text-[11px] outline-none focus:text-blue-600">
                    <select class="gt-select text-[10px] bg-white border rounded font-bold px-1">
                        <option value="Experimental" ${g.type === 'Experimental' ? 'selected' : ''}>EXP</option>
                        <option value="Control" ${g.type === 'Control' ? 'selected' : ''}>CTRL</option>
                    </select>
                    <button onclick="updateGroup('${g.id}')" class="text-blue-500 hover:bg-blue-50 p-1 rounded-lg">üíæ</button>
                    <button onclick="deleteGroup('${g.id}')" class="text-slate-300 hover:text-red-500 p-1 rounded-lg">‚úï</button>
                </div>`).join('');
        }

        function renderInputSelect() {
            const sel = document.getElementById('inputGrupo'); const cur = sel.value;
            sel.innerHTML = config.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            if (cur && config.groups.some(g => g.id === cur)) sel.value = cur;
        }

        function renderDynamicGroupReports() {
            const container = document.getElementById('dynamicGroupReportsContainer');
            config.groups.forEach(g => {
                if (!document.getElementById(`report-row-${g.id}`)) {
                    const section = document.createElement('div');
                    section.id = `report-row-${g.id}`;
                    section.className = "bg-white p-6 rounded-3xl shadow-xl border border-slate-100 space-y-4";
                    section.innerHTML = `
                        <div class="flex justify-between items-center border-b pb-2">
                            <h3 class="font-black text-slate-700 uppercase text-xs tracking-tight">${g.name}</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="chart-container"><canvas id="chartGrpSum-${g.id}"></canvas></div>
                            <div class="chart-container"><canvas id="chartGrpAnsSex-${g.id}"></canvas></div>
                            <div class="chart-container"><canvas id="chartGrpAttSex-${g.id}"></canvas></div>
                        </div>
                    `;
                    container.appendChild(section);
                }
            });
            Array.from(container.children).forEach(c => { if (!config.groups.find(g => g.id === c.id.replace('report-row-',''))) c.remove(); });
        }

        function renderSatisfaction() {
            const container = document.getElementById('satisfactionDetails');
            const expStudents = students.filter(s => {
                const g = config.groups.find(x => x.id === s.groupId);
                return g && g.type === 'Experimental' && s.post && s.post.val;
            });

            document.getElementById('valCount').innerText = `${expStudents.length} respuestas`;

            if (expStudents.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 italic text-xs py-10">Esperando datos post-test...</p>';
                return;
            }

            const stats = {
                ayuda: { Si: 0, Poco: 0, No: 0 },
                foco: { Si: 0, Poco: 0, No: 0 },
                repetir: { Si: 0, No: 0, Igual: 0 },
                sentido: [0, 0, 0, 0, 0] 
            };

            let sentidoSum = 0;
            let sentidoCount = 0;

            expStudents.forEach(s => {
                const v = s.post.val;
                if (stats.ayuda[v.ayuda] !== undefined) stats.ayuda[v.ayuda]++;
                if (stats.foco[v.foco] !== undefined) stats.foco[v.foco]++;
                if (stats.repetir[v.repetir] !== undefined) stats.repetir[v.repetir]++;
                if (v.sentido >= 1 && v.sentido <= 5) {
                    stats.sentido[v.sentido - 1]++;
                    sentidoSum += v.sentido;
                    sentidoCount++;
                }
            });

            const sentidoAvg = sentidoCount > 0 ? (sentidoSum / sentidoCount).toFixed(2).replace('.', ',') : '0,00';

            const renderBar = (label, count, total, color) => {
                const pct = total > 0 ? ((count / total) * 100).toFixed(0) : 0;
                return `
                    <div class="flex items-center gap-4 text-xs">
                        <div class="w-24 font-bold text-slate-600">${label}</div>
                        <div class="flex-1 stat-bar"><div class="stat-fill ${color}" style="width: ${pct}%"></div></div>
                        <div class="w-12 text-right font-black text-slate-900">${pct}%</div>
                        <div class="w-8 text-[10px] text-slate-400 italic">(${count})</div>
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="space-y-4">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-2">¬øTe ha ayudado la t√©cnica?</h4>
                        ${renderBar('S√≠, mucho', stats.ayuda.Si, expStudents.length, 'bg-emerald-500')}
                        ${renderBar('Un poco', stats.ayuda.Poco, expStudents.length, 'bg-amber-400')}
                        ${renderBar('Nada', stats.ayuda.No, expStudents.length, 'bg-rose-500')}
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-2">¬øNotas m√°s concentraci√≥n?</h4>
                        ${renderBar('S√≠', stats.foco.Si, expStudents.length, 'bg-blue-500')}
                        ${renderBar('Un poco', stats.foco.Poco, expStudents.length, 'bg-indigo-300')}
                        ${renderBar('Igual', stats.foco.No, expStudents.length, 'bg-slate-300')}
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-2">¬øRepetir√≠as en el futuro?</h4>
                        ${renderBar('S√≠', stats.repetir.Si, expStudents.length, 'bg-violet-500')}
                        ${renderBar('No', stats.repetir.No, expStudents.length, 'bg-slate-800')}
                        ${renderBar('Me es igual', stats.repetir.Igual, expStudents.length, 'bg-slate-400')}
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-end border-b pb-2">
                             <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Sensaci√≥n de Bienestar (1-5)</h4>
                             <div class="text-[10px] font-black text-emerald-700 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100">MEDIA: ${sentidoAvg}</div>
                        </div>
                        ${renderBar('5 - Excelente', stats.sentido[4], expStudents.length, 'bg-emerald-600')}
                        ${renderBar('4 - Muy bien', stats.sentido[3], expStudents.length, 'bg-emerald-400')}
                        ${renderBar('3 - Normal', stats.sentido[2], expStudents.length, 'bg-amber-300')}
                        ${renderBar('2 - Poco', stats.sentido[1], expStudents.length, 'bg-orange-400')}
                        ${renderBar('1 - Mal', stats.sentido[0], expStudents.length, 'bg-rose-600')}
                    </div>
                </div>
            `;
        }

        function renderTables() {
            const cont = document.getElementById('dynamicTablesContainer'); cont.innerHTML = '';
            config.groups.forEach(g => {
                const groupS = students.filter(s => s.groupId === g.id);
                cont.innerHTML += `
                    <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b flex justify-between items-center"><h3 class="font-black text-slate-800 text-[10px] uppercase">${g.name}</h3></div>
                        <div class="table-container">
                            <table>
                                <thead><tr><th class="text-left">ID</th><th class="text-center">Ans(Pre)</th><th class="text-center">Ans(Post)</th><th class="text-center">Atn(Pre)</th><th class="text-center">Atn(Post)</th><th class="text-right">ACC</th></tr></thead>
                                <tbody>${groupS.slice().reverse().map(s => `<tr><td class="font-mono font-black text-slate-800">${s.codigo}</td><td class="text-center text-slate-400">${s.pre?.ans.toFixed(2)||'-'}</td><td class="text-center font-black ${s.post?.ans < s.pre?.ans ? 'text-green-600 bg-green-50' : ''}">${s.post?.ans.toFixed(2)||'-'}</td><td class="text-center text-slate-400">${s.pre?.att.toFixed(2)||'-'}</td><td class="text-center font-black ${s.post?.att > s.pre?.att ? 'text-green-600 bg-green-50' : ''}">${s.post?.att.toFixed(2)||'-'}</td><td class="text-right space-x-1"><button onclick="editStudent('${s.codigo}')" class="text-blue-500 hover:bg-blue-100 p-1 rounded">‚úé</button><button onclick="deleteStudent('${s.codigo}')" class="text-slate-300 hover:text-red-500 p-1 rounded">‚úï</button></td></tr>`).join('')}</tbody>
                            </table>
                        </div>
                    </div>`;
            });
        }

        function renderObservations() {
            const pre = document.getElementById('obsContainerPre'); const post = document.getElementById('obsContainerPost'); pre.innerHTML = ''; post.innerHTML = '';
            students.forEach(s => {
                const g = config.groups.find(x => x.id === s.groupId)?.name || 'N/A';
                if (s.pre?.obs) pre.innerHTML += `<div class="p-3 bg-amber-50 rounded-xl border border-amber-100 shadow-sm"><span class="font-black text-amber-800">${s.codigo} (${g}):</span> <p class="mt-1 italic text-slate-700">"${s.pre.obs}"</p></div>`;
                if (s.post?.obs) post.innerHTML += `<div class="p-3 bg-emerald-50 rounded-xl border border-emerald-100 shadow-sm"><span class="font-black text-emerald-800">${s.codigo} (${g}):</span> <p class="mt-1 italic text-slate-700">"${s.post.obs}"</p></div>`;
            });
        }

        // --- GR√ÅFICAS: INICIALIZACI√ìN Y DATOS ---
        function initCharts() {
            const cfg = (t, c1, c2, maxVal) => ({ type: 'bar', data: { labels: [], datasets: [{ label: 'Pre', data: [], backgroundColor: c1 }, { label: 'Post', data: [], backgroundColor: c2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: t, font: { weight: 'bold', size: 12 } }, datalabels: { anchor: 'end', align: 'top', font: { weight: 'bold', size: 9 }, formatter: v => v > 0 ? v.toFixed(1) : '' } }, scales: { y: { beginAtZero: true, max: maxVal } } } });

            const safe = (id, config, store, key) => { const el = document.getElementById(id); if (!el) return; if (store[key]) store[key].destroy(); store[key] = new Chart(el, config); };

            // 1. Globales Totales
            safe('chartGlobalAnsiedad', cfg('ANSIEDAD GLOBAL', '#fda4af', '#e11d48', 40), charts.fixed, 'gAns');
            safe('chartGlobalAtencion', cfg('ATENCI√ìN GLOBAL', '#93c5fd', '#2563eb', 25), charts.fixed, 'gAtt');

            // 2. Globales por Sexo y Condici√≥n (LO NUEVO)
            const gSexAnsCfg = cfg('ANSIEDAD POR SEXO Y CONDICI√ìN', '#cbd5e1', '#f43f5e', 40);
            gSexAnsCfg.data.labels = ['Chicos (Exp)', 'Chicos (Ctrl)', 'Chicas (Exp)', 'Chicas (Ctrl)'];
            safe('chartGlobalSexAns', gSexAnsCfg, charts.fixed, 'gsAns');

            const gSexAttCfg = cfg('ATENCI√ìN POR SEXO Y CONDICI√ìN', '#cbd5e1', '#3b82f6', 25);
            gSexAttCfg.data.labels = ['Chicos (Exp)', 'Chicos (Ctrl)', 'Chicas (Exp)', 'Chicas (Ctrl)'];
            safe('chartGlobalSexAtt', gSexAttCfg, charts.fixed, 'gsAtt');

            // 3. Reportes de Aula
            config.groups.forEach(g => {
                if (!charts.groups[g.id]) charts.groups[g.id] = {};
                safe(`chartGrpSum-${g.id}`, cfg('PROGRESO GRUPO', '#94a3b8', '#3b82f6', 40), charts.groups[g.id], 'sum');
                safe(`chartGrpAnsSex-${g.id}`, cfg('ANSIEDAD/SEXO', '#cbd5e1', '#f43f5e', 40), charts.groups[g.id], 'aSex');
                safe(`chartGrpAttSex-${g.id}`, cfg('ATENCI√ìN/SEXO', '#cbd5e1', '#3b82f6', 25), charts.groups[g.id], 'tSex');
            });
        }

        function updateChartsData() {
            const getAvg = (cond, sex, phase, key) => {
                const valid = students.filter(s => {
                    const g = config.groups.find(x => x.id === s.groupId);
                    const condMatch = cond ? g?.type === cond : true;
                    const sexMatch = sex ? s.sexo === sex : true;
                    return condMatch && sexMatch && s[phase]?.[key] > 0;
                });
                return valid.length ? valid.reduce((a, b) => a + b[phase][key], 0) / valid.length : 0;
            };

            const getAvgGrp = (gid, phase, key) => { const v = students.filter(s => s.groupId === gid && s[phase]?.[key] > 0); return v.length ? v.reduce((a, b) => a + b[phase][key], 0) / v.length : 0; };
            const getAvgGrpSex = (gid, sex, phase, key) => { const v = students.filter(s => s.groupId === gid && s.sexo === sex && s[phase]?.[key] > 0); return v.length ? v.reduce((a, b) => a + b[phase][key], 0) / v.length : 0; };

            // Globales Totales
            if (charts.fixed.gAns) { charts.fixed.gAns.data.labels = ['Muestra Experimental', 'Muestra Control']; charts.fixed.gAns.data.datasets[0].data = [getAvg('Experimental',null,'pre','ans'), getAvg('Control',null,'pre','ans')]; charts.fixed.gAns.data.datasets[1].data = [getAvg('Experimental',null,'post','ans'), getAvg('Control',null,'post','ans')]; charts.fixed.gAns.update(); }
            if (charts.fixed.gAtt) { charts.fixed.gAtt.data.labels = ['Muestra Experimental', 'Muestra Control']; charts.fixed.gAtt.data.datasets[0].data = [getAvg('Experimental',null,'pre','att'), getAvg('Control',null,'pre','att')]; charts.fixed.gAtt.data.datasets[1].data = [getAvg('Experimental',null,'post','att'), getAvg('Control',null,'post','att')]; charts.fixed.gAtt.update(); }

            // Globales por Sexo y Condici√≥n (ACTUALIZAR)
            if (charts.fixed.gsAns) {
                charts.fixed.gsAns.data.datasets[0].data = [getAvg('Experimental','M','pre','ans'), getAvg('Control','M','pre','ans'), getAvg('Experimental','F','pre','ans'), getAvg('Control','F','pre','ans')];
                charts.fixed.gsAns.data.datasets[1].data = [getAvg('Experimental','M','post','ans'), getAvg('Control','M','post','ans'), getAvg('Experimental','F','post','ans'), getAvg('Control','F','post','ans')];
                charts.fixed.gsAns.update();
            }
            if (charts.fixed.gsAtt) {
                charts.fixed.gsAtt.data.datasets[0].data = [getAvg('Experimental','M','pre','att'), getAvg('Control','M','pre','att'), getAvg('Experimental','F','pre','att'), getAvg('Control','F','pre','att')];
                charts.fixed.gsAtt.data.datasets[1].data = [getAvg('Experimental','M','post','att'), getAvg('Control','M','post','att'), getAvg('Experimental','F','post','att'), getAvg('Control','F','post','att')];
                charts.fixed.gsAtt.update();
            }

            // Individuales
            config.groups.forEach(g => {
                if (charts.groups[g.id]) {
                    if (charts.groups[g.id].sum) { charts.groups[g.id].sum.data.labels = ['Ansiedad', 'Atenci√≥n']; charts.groups[g.id].sum.data.datasets[0].data = [getAvgGrp(g.id,'pre','ans'), getAvgGrp(g.id,'pre','att')]; charts.groups[g.id].sum.data.datasets[1].data = [getAvgGrp(g.id,'post','ans'), getAvgGrp(g.id,'post','att')]; charts.groups[g.id].sum.update(); }
                    if (charts.groups[g.id].aSex) { charts.groups[g.id].aSex.data.labels = ['Chicos', 'Chicas']; charts.groups[g.id].aSex.data.datasets[0].data = [getAvgGrpSex(g.id,'M','pre','ans'), getAvgGrpSex(g.id,'F','pre','ans')]; charts.groups[g.id].aSex.data.datasets[1].data = [getAvgGrpSex(g.id,'M','post','ans'), getAvgGrpSex(g.id,'F','post','ans')]; charts.groups[g.id].aSex.update(); }
                    if (charts.groups[g.id].tSex) { charts.groups[g.id].tSex.data.labels = ['Chicos', 'Chicas']; charts.groups[g.id].tSex.data.datasets[0].data = [getAvgGrpSex(g.id,'M','pre','att'), getAvgGrpSex(g.id,'F','pre','att')]; charts.groups[g.id].tSex.data.datasets[1].data = [getAvgGrpSex(g.id,'M','post','att'), getAvgGrpSex(g.id,'F','post','att')]; charts.groups[g.id].tSex.update(); }
                }
            });
        }

        // --- UTILIDADES ---
        function switchTab(p) { currentPhase = p; document.getElementById('tabPre').className = p === 'PRE' ? 'w-1/2 py-4 font-black tab-active' : 'w-1/2 py-4 font-black tab-inactive'; document.getElementById('tabPost').className = p === 'POST' ? 'w-1/2 py-4 font-black tab-active' : 'w-1/2 py-4 font-black tab-inactive'; document.getElementById('sectionPreExp').classList.toggle('hidden', p !== 'PRE'); document.getElementById('sectionPostVal').classList.toggle('hidden', p !== 'POST'); document.getElementById('btnPhaseText').innerText = p; checkGroupType(); }
        function checkGroupType() { const g = config.groups.find(x => x.id === document.getElementById('inputGrupo').value); if (currentPhase === 'POST') document.getElementById('sectionPostVal').classList.toggle('hidden', !g || g.type !== 'Experimental'); }
        function clearForm() { document.getElementById('codigo').value = ''; document.querySelectorAll('input[type="number"]').forEach(i => i.value = ''); document.getElementById('observaciones').value = ''; }
        function checkExistingStudent() { const s = students.find(x => x.codigo === document.getElementById('codigo').value.toUpperCase().trim()); if (s) { document.getElementById('inputGrupo').value = s.groupId; document.getElementById('sexo').value = s.sexo; checkGroupType(); } }
        function editStudent(code) { const s = students.find(x => x.codigo === code); if (!s) return; document.getElementById('codigo').value = s.codigo; document.getElementById('inputGrupo').value = s.groupId; document.getElementById('sexo').value = s.sexo; const d = currentPhase === 'PRE' ? s.pre : s.post; if (d) { d.rawAns?.forEach((v, i) => document.getElementById('a'+(i+1)).value = v); d.rawAtt?.forEach((v, i) => document.getElementById('at'+(i+1)).value = v); document.getElementById('observaciones').value = d.obs || ''; } checkGroupType(); }
        function deleteStudent(code) { if (confirm(`¬øBorrar a ${code}?`)) { students = students.filter(s => s.codigo !== code); saveData(); renderAll(); } }
        function showMsg(t, c) { const m = document.getElementById('msg'); m.innerText = t; m.className = "text-center text-[11px] font-bold mt-4 h-4 " + c; setTimeout(() => m.innerText = "", 3000); }
        function saveData() { localStorage.setItem('tfm_students_v50', JSON.stringify(students)); localStorage.setItem('tfm_groups_v50', JSON.stringify(config.groups)); }
        function loadData() { const s = localStorage.getItem('tfm_students_v50') || localStorage.getItem('tfm_students_v49'); const g = localStorage.getItem('tfm_groups_v50') || localStorage.getItem('tfm_groups_v49'); if (s) students = JSON.parse(s); if (g) config.groups = JSON.parse(g); }
        function downloadBackup() { const b = new Blob([JSON.stringify({students, groups: config.groups})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backup_v50.json'; a.click(); }
        function loadBackupFile(input) { const r = new FileReader(); r.onload = (e) => { const d = JSON.parse(e.target.result); students = d.students; config.groups = d.groups; saveData(); renderAll(); }; r.readAsText(input.files[0]); }
        function exportToCSV() {
            let csv = "\uFEFFCODIGO,GRUPO,TIPO,SEXO,ANS_PRE,ANS_POST,AT_PRE,AT_POST,VAL_AYUDA,VAL_SENTIDO,VAL_FOCO,VAL_REPETIR\n";
            students.forEach(s => { const g = config.groups.find(x => x.id === s.groupId); csv += `"${s.codigo}","${g?.name||'N/A'}","${g?.type||'N/A'}","${s.sexo}",${s.pre?.ans||0},${s.post?.ans||0},${s.pre?.att||0},${s.post?.att||0},"${s.post?.val?.ayuda||''}",${s.post?.val?.sentido||0},"${s.post?.val?.foco||''}", "${s.post?.val?.repetir||''}"\n`; });
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'datos_tfm_v50.csv'; a.click();
        }
    </script>
</body>
</html>