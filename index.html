<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Datos TFM - Versi√≥n 32 (Sit. Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js 4.4.1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Plugin DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .chart-container { position: relative; height: 250px; width: 100%; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #1e40af; background-color: #eff6ff; }
        .tab-inactive { color: #6b7280; cursor: pointer; }
        .tab-inactive:hover { background-color: #f9fafb; }
        @media (max-width: 768px) { .input-item { width: 100%; } .chart-container { height: 200px; } }
    </style>
</head>
<body class="p-4 md:p-6 text-gray-800">

    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-col md:flex-row justify-between items-center border-l-4 border-indigo-600 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    üìä TFM Analytics
                    <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">v32 Final</span>
                </h1>
                <p class="text-gray-500 text-sm">Incluye gr√°fica comparativa de Situaci√≥n Final (Post-Test).</p>
            </div>
            <div class="flex flex-wrap gap-2 justify-center md:justify-end text-sm">
                <input type="file" id="fileInput" class="hidden" accept=".json" onchange="loadBackupFile(this)">
                <button onclick="document.getElementById('fileInput').click()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded shadow flex items-center gap-1 transition-colors">üìÇ Cargar</button>
                <button onclick="downloadBackup()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded shadow flex items-center gap-1 transition-colors">üíæ Backup</button>
                <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded shadow flex items-center gap-1 transition-colors">üì• Excel</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- COLUMNA IZQUIERDA: FORMULARIO -->
            <div class="lg:col-span-1 bg-white rounded-lg shadow-md h-fit border-t-4 border-blue-600 overflow-hidden">
                
                <div class="flex border-b">
                    <div onclick="switchTab('PRE')" id="tabPre" class="w-1/2 py-3 text-center font-bold tab-active transition-all">üìù PRE-TEST</div>
                    <div onclick="switchTab('POST')" id="tabPost" class="w-1/2 py-3 text-center font-bold tab-inactive transition-all">üèÅ POST-TEST</div>
                </div>

                <div class="p-5">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex justify-between items-center">
                        <span id="modeTitle">Datos Pre-Test</span>
                    </h2>

                    <!-- Campos Comunes -->
                    <div class="grid grid-cols-2 gap-3 mb-4 p-3 bg-gray-50 rounded border">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">C√ìDIGO</label>
                            <input type="text" id="codigo" placeholder="Ej: MAJU15" class="w-full border border-gray-300 rounded p-2 uppercase focus:ring-2 focus:ring-blue-500 outline-none font-mono font-bold" onblur="checkExistingStudent()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">GRUPO</label>
                            <select id="grupo" class="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="Experimental">3¬∫B (Exper.)</option>
                                <option value="Control">3¬∫A (Control)</option>
                            </select>
                        </div>
                        <div class="demog-fields">
                            <label class="block text-xs font-bold text-gray-600 mb-1">SEXO</label>
                            <select id="sexo" class="w-full border border-gray-300 rounded p-2 text-sm"><option value="-">-</option><option value="M">Masc</option><option value="F">Fem</option></select>
                        </div>
                        <div class="demog-fields">
                            <label class="block text-xs font-bold text-gray-600 mb-1">EDAD</label>
                            <input type="number" id="edad" placeholder="14" class="w-full border border-gray-300 rounded p-2 text-sm">
                        </div>
                    </div>

                    <!-- SECCI√ìN PRE -->
                    <div id="sectionPre" class="block space-y-4">
                        <div class="p-3 bg-gray-50 rounded border border-gray-200">
                            <h3 class="text-xs font-bold text-gray-600 mb-2 uppercase">Bloque 0: Experiencia</h3>
                            <div class="space-y-2">
                                <div>
                                    <label class="block text-[10px] text-gray-500">¬øHas practicado antes?</label>
                                    <select id="exp_sino" class="w-full border rounded p-1 text-sm"><option value="No">No</option><option value="Si">S√≠</option></select>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500">Frecuencia</label>
                                    <select id="exp_freq" class="w-full border rounded p-1 text-sm"><option value="">-</option><option value="Pocas">Muy pocas veces</option><option value="A veces">A veces</option><option value="Habitual">Habitualmente</option></select>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-500">¬øD√≥nde?</label>
                                    <input type="text" id="exp_donde" placeholder="Ej: Colegio, App..." class="w-full border rounded p-1 text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-3 bg-red-50 rounded border border-red-100">
                            <h3 class="text-xs font-bold text-red-800 mb-2 uppercase">Distractores</h3>
                            <div class="grid grid-cols-2 gap-2 text-xs text-gray-700">
                                <label class="flex items-center"><input type="checkbox" id="d_comp" class="mr-1">Compa√±eros</label>
                                <label class="flex items-center"><input type="checkbox" id="d_ruido" class="mr-1">Ruido</label>
                                <label class="flex items-center"><input type="checkbox" id="d_cans" class="mr-1">Cansancio</label>
                                <label class="flex items-center"><input type="checkbox" id="d_preoc" class="mr-1">Preocup.</label>
                                <label class="flex items-center"><input type="checkbox" id="d_aburr" class="mr-1">Aburrim.</label>
                                <label class="flex items-center"><input type="checkbox" id="d_olor" class="mr-1">Mal Olor</label>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN POST -->
                    <div id="sectionPost" class="hidden space-y-4">
                        <div id="blockVal" class="p-3 bg-green-50 rounded border border-green-200 hidden">
                            <h3 class="text-xs font-bold text-green-800 mb-2 uppercase">Valoraci√≥n (Solo Exp)</h3>
                            <div class="space-y-2 text-xs">
                                <div><label class="font-bold">1. ¬øTe ha ayudado?</label><select id="val_ayuda" class="w-full border p-1 rounded"><option value="-">-</option><option value="No">No, nada</option><option value="Poco">Un poco</option><option value="Si">S√≠, bastante</option></select></div>
                                <div><label class="font-bold">2. Sensaci√≥n (1-5)</label><input type="number" id="val_sentido" min="1" max="5" class="w-full border p-1 rounded"></div>
                                <div><label class="font-bold">3. ¬øM√°s f√°cil atender?</label><select id="val_facil" class="w-full border p-1 rounded"><option value="-">-</option><option value="No">No, igual</option><option value="Si">S√≠, m√°s concentrado</option></select></div>
                                <div><label class="font-bold">4. ¬øRepetir futuro?</label><select id="val_futuro" class="w-full border p-1 rounded"><option value="-">-</option><option value="Si">S√≠</option><option value="No">No</option><option value="Igual">Me da igual</option></select></div>
                            </div>
                        </div>
                        <div id="blockValMsg" class="text-xs text-gray-400 italic text-center p-2 border border-dashed rounded hidden">Grupo Control: No rellena valoraci√≥n.</div>
                    </div>

                    <!-- CAMPOS COMUNES -->
                    <div class="mt-4 space-y-3">
                        <div class="p-2 bg-blue-50 rounded border border-blue-100">
                            <h3 class="text-xs font-bold text-blue-800 mb-1 flex justify-between">
                                <span>B1: Ansiedad (1-4)</span>
                                <span class="opacity-50 text-[10px]">0 = No contesta</span>
                            </h3>
                            <div class="grid grid-cols-5 gap-1">
                                <input type="number" id="a1" class="border text-center rounded text-sm py-1" placeholder="1"><input type="number" id="a2" class="border text-center rounded text-sm py-1" placeholder="2"><input type="number" id="a3" class="border text-center rounded text-sm py-1" placeholder="3"><input type="number" id="a4" class="border text-center rounded text-sm py-1" placeholder="4"><input type="number" id="a5" class="border text-center rounded text-sm py-1" placeholder="5">
                                <input type="number" id="a6" class="border text-center rounded text-sm py-1" placeholder="6"><input type="number" id="a7" class="border text-center rounded text-sm py-1" placeholder="7"><input type="number" id="a8" class="border text-center rounded text-sm py-1" placeholder="8"><input type="number" id="a9" class="border text-center rounded text-sm py-1" placeholder="9"><input type="number" id="a10" class="border text-center rounded text-sm py-1" placeholder="10">
                            </div>
                        </div>
                        <div class="p-2 bg-purple-50 rounded border border-purple-100">
                            <h3 class="text-xs font-bold text-purple-800 mb-1 flex justify-between">
                                <span>B2: Atenci√≥n (1-5)</span>
                                <span class="opacity-50 text-[10px]">0 = No contesta</span>
                            </h3>
                            <div class="grid grid-cols-5 gap-1">
                                <input type="number" id="at1" class="border text-center rounded text-sm py-1" placeholder="1"><input type="number" id="at2" class="border text-center rounded text-sm py-1" placeholder="2"><input type="number" id="at3" class="border text-center rounded text-sm py-1" placeholder="3"><input type="number" id="at4" class="border text-center rounded text-sm py-1" placeholder="4"><input type="number" id="at5" class="border text-center rounded text-sm py-1" placeholder="5">
                            </div>
                        </div>
                        <textarea id="observaciones" class="w-full border rounded p-2 text-xs h-12 placeholder-gray-400 bg-yellow-50 border-yellow-100" placeholder="Observaciones..."></textarea>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button id="btnSave" onclick="saveDataEntry()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded shadow transition-colors flex justify-center items-center gap-2">üíæ Guardar <span id="btnPhaseText">PRE</span></button>
                        <button onclick="clearForm()" class="bg-gray-200 text-gray-600 px-3 rounded hover:bg-gray-300">Limpiar</button>
                    </div>
                    <p id="msg" class="text-center text-xs font-bold mt-2 h-4"></p>
                </div>
            </div>

            <!-- COLUMNA DERECHA: RESULTADOS -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- 1. TABLAS DE ALUMNOS (DIVIDIDAS) -->
                <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-gray-600">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-bold text-gray-800">Alumnos (<span id="count">0</span>)</h2>
                        <button onclick="wipeAll()" class="text-xs text-red-500 hover:underline">Borrar Todo</button>
                    </div>

                    <!-- EXPERIMENTAL -->
                    <h3 class="text-sm font-bold text-blue-800 bg-blue-50 p-2 rounded-t border border-blue-100 mt-2">Grupo Experimental (3¬∫B)</h3>
                    <div class="overflow-x-auto border-x border-b rounded-b shadow-inner bg-gray-50 mb-4 max-h-60">
                        <table class="min-w-full divide-y divide-gray-200 text-xs">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-2 py-2 text-left">C√≥d</th>
                                    <th class="px-2 py-2 text-center bg-blue-50">Ans(Pre)</th>
                                    <th class="px-2 py-2 text-center bg-blue-100 font-bold">Ans(Post)</th>
                                    <th class="px-2 py-2 text-center bg-purple-50">Atn(Pre)</th>
                                    <th class="px-2 py-2 text-center bg-purple-100 font-bold">Atn(Post)</th>
                                    <th class="px-2 py-2 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="tableBodyExp" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>

                    <!-- CONTROL -->
                    <h3 class="text-sm font-bold text-gray-700 bg-gray-100 p-2 rounded-t border border-gray-200 mt-2">Grupo Control (3¬∫A)</h3>
                    <div class="overflow-x-auto border-x border-b rounded-b shadow-inner bg-gray-50 mb-4 max-h-60">
                        <table class="min-w-full divide-y divide-gray-200 text-xs">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-2 py-2 text-left">C√≥d</th>
                                    <th class="px-2 py-2 text-center bg-blue-50">Ans(Pre)</th>
                                    <th class="px-2 py-2 text-center bg-blue-100 font-bold">Ans(Post)</th>
                                    <th class="px-2 py-2 text-center bg-purple-50">Atn(Pre)</th>
                                    <th class="px-2 py-2 text-center bg-purple-100 font-bold">Atn(Post)</th>
                                    <th class="px-2 py-2 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="tableBodyCtrl" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. REGISTRO DE OBSERVACIONES (SEPARADO) -->
                <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-yellow-500">
                    <h2 class="text-lg font-bold text-yellow-800 mb-2">Observaciones (Pre y Post)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div>
                            <h3 class="text-xs font-bold text-blue-800 bg-blue-50 p-1 rounded-t">PRE-TEST</h3>
                            <div class="overflow-x-auto border rounded-b bg-white max-h-40"><table class="min-w-full divide-y text-xs"><tbody id="obsPreExp"></tbody></table></div>
                            <div class="overflow-x-auto border rounded-b bg-white max-h-40 mt-1"><table class="min-w-full divide-y text-xs"><tbody id="obsPreCtrl"></tbody></table></div>
                        </div>
                        <div>
                            <h3 class="text-xs font-bold text-green-800 bg-green-50 p-1 rounded-t">POST-TEST</h3>
                            <div class="overflow-x-auto border rounded-b bg-white max-h-40"><table class="min-w-full divide-y text-xs"><tbody id="obsPostExp"></tbody></table></div>
                            <div class="overflow-x-auto border rounded-b bg-white max-h-40 mt-1"><table class="min-w-full divide-y text-xs"><tbody id="obsPostCtrl"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- 3. EXPERIENCIA PREVIA -->
                <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-gray-500">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-bold text-gray-800">Experiencia Previa</h2>
                        <div id="expSummary" class="text-xs bg-gray-100 px-3 py-1 rounded border font-mono"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div class="overflow-x-auto border rounded bg-white max-h-40"><table class="min-w-full divide-y text-xs"><tbody id="expTableBodyExp"></tbody></table></div>
                        <div class="overflow-x-auto border rounded bg-white max-h-40"><table class="min-w-full divide-y text-xs"><tbody id="expTableBodyCtrl"></tbody></table></div>
                    </div>
                </div>

                <!-- 4. VALORACI√ìN -->
                <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-green-500">
                    <h2 class="text-lg font-bold text-green-800 mb-2">Valoraci√≥n Post-Test (Experimental)</h2>
                    <div class="overflow-x-auto"><table class="min-w-full text-xs divide-y border"><tbody id="valTableBody"></tbody></table></div>
                </div>

                <!-- GR√ÅFICAS -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- EVOLUCI√ìN (COMPARATIVAS PRE vs POST) -->
                    <div class="bg-white p-3 rounded shadow border"><div class="chart-container"><canvas id="chartCompAnsiedad"></canvas></div></div>
                    <div class="bg-white p-3 rounded shadow border"><div class="chart-container"><canvas id="chartCompAtencion"></canvas></div></div>
                    
                    <!-- SITUACI√ìN INICIAL vs FINAL -->
                    <div class="bg-white p-3 rounded shadow border"><div class="chart-container"><canvas id="chartInitialBar"></canvas></div></div>
                    <div class="bg-white p-3 rounded shadow border"><div class="chart-container"><canvas id="chartFinalBar"></canvas></div></div>

                    <!-- SEXO (Full Width) -->
                    <div class="bg-white p-3 rounded shadow border md:col-span-2"><div class="chart-container"><canvas id="chartSexoAnsiedad"></canvas></div></div>
                    <div class="bg-white p-3 rounded shadow border md:col-span-2"><div class="chart-container"><canvas id="chartSexoAtencion"></canvas></div></div>
                    
                    <!-- OTROS -->
                    <div class="bg-white p-3 rounded shadow border md:col-span-2"><div class="chart-container"><canvas id="chartDistractores"></canvas></div></div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let students = [];
        let currentPhase = 'PRE';
        let charts = {};

        function customRound(num) {
            if (typeof num !== 'number' || isNaN(num)) return 0;
            let scaled = num * 100;
            let integerPart = Math.floor(scaled);
            let fractionalPart = scaled - integerPart;
            let result = fractionalPart > 0.50000001 ? (integerPart + 1) / 100 : integerPart / 100;
            return parseFloat(result.toFixed(2));
        }

        function fmt(num) {
            return customRound(num).toFixed(2).replace('.', ',');
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);
            loadData(); 
            try { if (typeof Chart !== 'undefined') { initCharts(); updateCharts(); } } catch (e) { console.error(e); }
            render();
        });

        function switchTab(phase) {
            currentPhase = phase;
            document.getElementById('tabPre').className = phase === 'PRE' ? 'w-1/2 py-3 text-center font-bold tab-active' : 'w-1/2 py-3 text-center font-bold tab-inactive';
            document.getElementById('tabPost').className = phase === 'POST' ? 'w-1/2 py-3 text-center font-bold tab-active' : 'w-1/2 py-3 text-center font-bold tab-inactive';
            
            document.getElementById('sectionPre').classList.toggle('hidden', phase !== 'PRE');
            document.getElementById('sectionPost').classList.toggle('hidden', phase !== 'POST');
            document.querySelectorAll('.demog-fields').forEach(el => el.style.display = phase === 'PRE' ? 'block' : 'none');
            
            document.getElementById('modeTitle').innerText = phase === 'PRE' ? 'Datos Pre-Test' : 'Datos Post-Test';
            document.getElementById('btnPhaseText').innerText = phase;
            checkGroupVisibility();
        }

        document.getElementById('grupo').addEventListener('change', checkGroupVisibility);
        function checkGroupVisibility() {
            const grp = document.getElementById('grupo').value;
            if (currentPhase === 'POST') {
                if (grp === 'Experimental') {
                    document.getElementById('blockVal').classList.remove('hidden');
                    document.getElementById('blockValMsg').classList.add('hidden');
                } else {
                    document.getElementById('blockVal').classList.add('hidden');
                    document.getElementById('blockValMsg').classList.remove('hidden');
                }
            }
        }

        function checkExistingStudent() {
            const code = document.getElementById('codigo').value.toUpperCase().trim();
            if(!code) return;
            const existing = students.find(s => s.codigo === code);
            if (existing) {
                document.getElementById('grupo').value = existing.grupo;
                document.getElementById('sexo').value = existing.sexo;
                document.getElementById('edad').value = existing.edad;
                showMessage(`Alumno ${code} encontrado.`, 'text-blue-600');
            }
        }

        // L√ìGICA DE CALCULO PROPORCIONAL
        function saveDataEntry() {
            const code = document.getElementById('codigo').value.toUpperCase().trim();
            if (!code) return showMessage('‚ùå Falta el C√≥digo', 'text-red-600');

            const rawAns = [];
            for(let i=1; i<=10; i++) rawAns.push(parseInt(document.getElementById('a'+i).value) || 0); // 0 si vac√≠o
            const rawAtt = [];
            for(let i=1; i<=5; i++) rawAtt.push(parseInt(document.getElementById('at'+i).value) || 0); // 0 si vac√≠o

            // --- C√ÅLCULO ANSIEDAD PROPORCIONAL ---
            let sumAns = 0;
            let countAns = 0;
            const invIdx = [0, 3, 5, 7, 9];

            rawAns.forEach((val, i) => {
                if (val > 0) { 
                    countAns++;
                    if (invIdx.includes(i)) {
                        sumAns += (5 - val);
                    } else {
                        sumAns += val;
                    }
                }
            });

            let totAns = countAns > 0 ? (sumAns / countAns) * 10 : 0;
            totAns = customRound(totAns);

            // --- C√ÅLCULO ATENCI√ìN PROPORCIONAL ---
            let sumAtt = 0;
            let countAtt = 0;
            rawAtt.forEach((val, i) => {
                if (val > 0) {
                    countAtt++;
                    if (i === 4) {
                        sumAtt += (6 - val);
                    } else {
                        sumAtt += val;
                    }
                }
            });

            let totAtt = countAtt > 0 ? (sumAtt / countAtt) * 5 : 0;
            totAtt = customRound(totAtt);

            let student = students.find(s => s.codigo === code);
            if (!student) {
                student = { 
                    codigo: code, grupo: document.getElementById('grupo').value, 
                    sexo: document.getElementById('sexo').value, edad: document.getElementById('edad').value, 
                    pre: null, post: null 
                };
                students.push(student);
            } else {
                if(currentPhase === 'PRE') {
                    student.grupo = document.getElementById('grupo').value;
                    student.sexo = document.getElementById('sexo').value;
                    student.edad = document.getElementById('edad').value;
                }
            }

            const obs = document.getElementById('observaciones').value.replace(/[\r\n,]/g, ' ').trim();

            if (currentPhase === 'PRE') {
                student.pre = {
                    ans: totAns, att: totAtt, rawAns, rawAtt, obs,
                    exp: { si: document.getElementById('exp_sino').value, freq: document.getElementById('exp_freq').value, donde: document.getElementById('exp_donde').value },
                    dist: {
                        comp: document.getElementById('d_comp').checked, ruido: document.getElementById('d_ruido').checked,
                        cans: document.getElementById('d_cans').checked, preoc: document.getElementById('d_preoc').checked,
                        aburr: document.getElementById('d_aburr').checked, olor: document.getElementById('d_olor').checked
                    }
                };
            } else {
                student.post = {
                    ans: totAns, att: totAtt, rawAns, rawAtt, obs,
                    val: {
                        ayuda: document.getElementById('val_ayuda').value,
                        sentido: parseInt(document.getElementById('val_sentido').value) || 0,
                        facil: document.getElementById('val_facil').value,
                        futuro: document.getElementById('val_futuro').value
                    }
                };
            }

            saveToLocal(); render(); clearForm();
            showMessage(`‚úî ${currentPhase} guardado para ${code}`, 'text-green-600');
        }

        function render() {
            // Limpiar TBODIES
            document.getElementById('tableBodyExp').innerHTML = '';
            document.getElementById('tableBodyCtrl').innerHTML = '';

            students.slice().reverse().forEach(s => {
                const preAns = s.pre ? fmt(s.pre.ans) : '-';
                const postAns = s.post ? `<b>${fmt(s.post.ans)}</b>` : '-';
                const preAtt = s.pre ? fmt(s.pre.att) : '-';
                const postAtt = s.post ? `<b>${fmt(s.post.att)}</b>` : '-';
                let ansColor = '', attColor = '';
                if(s.pre && s.post) {
                    if(s.post.ans < s.pre.ans) ansColor = 'text-green-600 font-bold';
                    if(s.post.att > s.pre.att) attColor = 'text-green-600 font-bold';
                }

                const row = `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-2 py-2 font-mono font-bold text-xs">${s.codigo}</td>
                        <td class="px-2 py-2 text-center text-xs text-gray-500">${preAns}</td>
                        <td class="px-2 py-2 text-center text-xs ${ansColor}">${postAns}</td>
                        <td class="px-2 py-2 text-center text-xs text-gray-500">${preAtt}</td>
                        <td class="px-2 py-2 text-center text-xs ${attColor}">${postAtt}</td>
                        <td class="px-2 py-2 text-center">
                            <button onclick="editStudent('${s.codigo}')" class="text-blue-500 font-bold px-1" title="Editar">‚úé</button>
                            <button onclick="delStudent('${s.codigo}')" class="text-red-500 font-bold px-1" title="Borrar">‚úï</button>
                        </td>
                    </tr>
                `;

                if (s.grupo === 'Experimental') {
                    document.getElementById('tableBodyExp').innerHTML += row;
                } else {
                    document.getElementById('tableBodyCtrl').innerHTML += row;
                }
            });
            document.getElementById('count').innerText = students.length;
            
            updateExpTable();
            updateObsTable(); 
            updateValTable();
            updateCharts();
        }

        // --- UPDATE EXP TABLE: FILTRADO Y DIVIDIDO ---
        function updateExpTable() {
            const tbodyExp = document.getElementById('expTableBodyExp');
            const tbodyCtrl = document.getElementById('expTableBodyCtrl');
            const summaryDiv = document.getElementById('expSummary');
            tbodyExp.innerHTML = '';
            tbodyCtrl.innerHTML = '';
            let countSi = 0, countNo = 0;

            students.forEach(s => {
                if (s.pre) {
                    const expSiNo = s.pre.exp.si;
                    if(expSiNo === 'Si') {
                        countSi++; 
                        const expClass = 'text-green-600 font-bold';
                        const row = `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-2 py-1 font-mono text-xs">${s.codigo}</td>
                                <td class="px-2 py-1 text-xs ${expClass}">${expSiNo}</td>
                                <td class="px-2 py-1 text-xs text-gray-600">${s.pre.exp.freq || '-'}</td>
                                <td class="px-2 py-1 text-xs text-gray-600 italic truncate max-w-[150px]">${s.pre.exp.donde || '-'}</td>
                            </tr>`;
                        
                        if (s.grupo === 'Experimental') tbodyExp.innerHTML += row;
                        else tbodyCtrl.innerHTML += row;
                    } else {
                        countNo++;
                    }
                }
            });
            
            if (tbodyExp.innerHTML === '') tbodyExp.innerHTML = '<tr><td colspan="4" class="px-2 py-1 text-center text-gray-400 text-xs">Ninguno.</td></tr>';
            if (tbodyCtrl.innerHTML === '') tbodyCtrl.innerHTML = '<tr><td colspan="4" class="px-2 py-1 text-center text-gray-400 text-xs">Ninguno.</td></tr>';
            
            summaryDiv.innerHTML = `<span class="text-green-700 font-bold mr-3">S√≠: ${countSi}</span><span class="text-gray-500 font-bold">No: ${countNo}</span>`;
        }

        // --- UPDATE OBS TABLE: SEPARADO POR FASES ---
        function updateObsTable() {
            const preExp = document.getElementById('obsPreExp');
            const preCtrl = document.getElementById('obsPreCtrl');
            const postExp = document.getElementById('obsPostExp');
            const postCtrl = document.getElementById('obsPostCtrl');

            preExp.innerHTML = ''; preCtrl.innerHTML = '';
            postExp.innerHTML = ''; postCtrl.innerHTML = '';
            
            let hasPreExp=false, hasPreCtrl=false, hasPostExp=false, hasPostCtrl=false;

            students.forEach(s => {
                // OBS PRE
                if (s.pre && s.pre.obs && s.pre.obs.trim() !== "") {
                    const row = `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-2 py-1 font-mono text-xs text-gray-700 font-bold w-16 align-top">${s.codigo}</td>
                            <td class="px-2 py-1 text-xs text-gray-800 italic">"${s.pre.obs}"</td>
                        </tr>`;
                    if (s.grupo === 'Experimental') { preExp.innerHTML += row; hasPreExp=true; }
                    else { preCtrl.innerHTML += row; hasPreCtrl=true; }
                }
                
                // OBS POST
                if (s.post && s.post.obs && s.post.obs.trim() !== "") {
                    const row = `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-2 py-1 font-mono text-xs text-gray-700 font-bold w-16 align-top">${s.codigo}</td>
                            <td class="px-2 py-1 text-xs text-gray-800 italic">"${s.post.obs}"</td>
                        </tr>`;
                    if (s.grupo === 'Experimental') { postExp.innerHTML += row; hasPostExp=true; }
                    else { postCtrl.innerHTML += row; hasPostCtrl=true; }
                }
            });

            const emptyRow = '<tr><td colspan="2" class="px-2 py-2 text-center text-gray-400 text-xs">Sin observaciones.</td></tr>';
            if(!hasPreExp) preExp.innerHTML = emptyRow;
            if(!hasPreCtrl) preCtrl.innerHTML = emptyRow;
            if(!hasPostExp) postExp.innerHTML = emptyRow;
            if(!hasPostCtrl) postCtrl.innerHTML = emptyRow;
        }

        function updateValTable() {
            const expStudents = students.filter(s => s.grupo === 'Experimental' && s.post && s.post.val);
            const total = expStudents.length;
            const tbody = document.getElementById('valTableBody');
            if (total === 0) { tbody.innerHTML = '<tr><td colspan="2" class="px-3 py-2 text-center text-gray-400">Sin datos Post-Test.</td></tr>'; return; }

            let ayuda = { si:0, poco:0, no:0 }, facil = { si:0, no:0 }, futuro = { si:0, no:0, igual:0 };
            let sentidoSum = 0, sentidoCount = 0;

            expStudents.forEach(s => {
                const v = s.post.val;
                if (v.ayuda === 'Si') ayuda.si++; else if (v.ayuda === 'Poco') ayuda.poco++; else if (v.ayuda === 'No') ayuda.no++;
                if (v.facil === 'Si') facil.si++; else if (v.facil === 'No') facil.no++;
                if (v.futuro === 'Si') futuro.si++; else if (v.futuro === 'No') futuro.no++; else if (v.futuro === 'Igual') futuro.igual++;
                if (v.sentido > 0) { sentidoSum += v.sentido; sentidoCount++; }
            });

            const pct = (n) => customRound((n/total)*100).toFixed(2).replace('.',',') + '%';
            const avgSentido = sentidoCount ? fmt(sentidoSum/sentidoCount) : '-';

            tbody.innerHTML = `
                <tr class="border-b"><td class="px-3 py-2 text-xs"><b>1. Ayuda</b></td><td class="px-3 py-2 text-right text-xs">S√≠: <b>${pct(ayuda.si)}</b> | Poco: ${pct(ayuda.poco)} | No: ${pct(ayuda.no)}</td></tr>
                <tr class="border-b"><td class="px-3 py-2 text-xs"><b>2. Sensaci√≥n (1-5)</b></td><td class="px-3 py-2 text-right text-xs font-bold text-blue-600">${avgSentido} / 5,00</td></tr>
                <tr class="border-b"><td class="px-3 py-2 text-xs"><b>3. Atender mejor</b></td><td class="px-3 py-2 text-right text-xs">S√≠: <b>${pct(facil.si)}</b> | No: ${pct(facil.no)}</td></tr>
                <tr><td class="px-3 py-2 text-xs"><b>4. Repetir</b></td><td class="px-3 py-2 text-right text-xs">S√≠: <b>${pct(futuro.si)}</b> | No: ${pct(futuro.no)} | Igual: ${pct(futuro.igual)}</td></tr>
            `;
        }

        function updateCharts() {
            if (!charts.ans) return;
            const exp = students.filter(s => s.grupo === 'Experimental');
            const ctrl = students.filter(s => s.grupo === 'Control');
            // Helper Media FILTRADA (Ignora 0)
            const avg = (arr, phase, key) => { 
                const valid = arr.filter(s => s[phase] && s[phase][key] > 0); 
                if (!valid.length) return 0; 
                return customRound(valid.reduce((acc, s) => acc + s[phase][key], 0) / valid.length);
            };

            charts.ans.data.datasets[0].data = [avg(exp,'pre','ans'), avg(ctrl,'pre','ans')];
            charts.ans.data.datasets[1].data = [avg(exp,'post','ans'), avg(ctrl,'post','ans')];
            charts.ans.update();

            charts.att.data.datasets[0].data = [avg(exp,'pre','att'), avg(ctrl,'pre','att')];
            charts.att.data.datasets[1].data = [avg(exp,'post','att'), avg(ctrl,'post','att')];
            charts.att.update();

            // GR√ÅFICA 3: SITUACI√ìN INICIAL (PRE)
            const preAnsExp = avg(exp, 'pre', 'ans'); const preAnsCtrl = avg(ctrl, 'pre', 'ans');
            const preAttExp = avg(exp, 'pre', 'att'); const preAttCtrl = avg(ctrl, 'pre', 'att');
            charts.initBar.data.datasets[0].data = [preAnsExp, preAnsCtrl];
            charts.initBar.data.datasets[1].data = [preAttExp, preAttCtrl];
            charts.initBar.update();

            // GR√ÅFICA 4: SITUACI√ìN FINAL (POST)
            const postAnsExp = avg(exp, 'post', 'ans'); const postAnsCtrl = avg(ctrl, 'post', 'ans');
            const postAttExp = avg(exp, 'post', 'att'); const postAttCtrl = avg(ctrl, 'post', 'att');
            charts.finalBar.data.datasets[0].data = [postAnsExp, postAnsCtrl];
            charts.finalBar.data.datasets[1].data = [postAttExp, postAttCtrl];
            charts.finalBar.update();

            let counts = [0,0,0,0,0,0];
            students.forEach(s => { if(s.pre && s.pre.dist) { if(s.pre.dist.comp) counts[0]++; if(s.pre.dist.ruido) counts[1]++; if(s.pre.dist.cans) counts[2]++; if(s.pre.dist.preoc) counts[3]++; if(s.pre.dist.aburr) counts[4]++; if(s.pre.dist.olor) counts[5]++; } });
            charts.dist.data.datasets[0].data = counts;
            charts.dist.update();

            const mExp = exp.filter(s => s.sexo === 'M'), mCtrl = ctrl.filter(s => s.sexo === 'M');
            const fExp = exp.filter(s => s.sexo === 'F'), fCtrl = ctrl.filter(s => s.sexo === 'F');
            charts.sexoAns.data.datasets[0].data = [avg(mExp,'pre','ans'), avg(mCtrl,'pre','ans'), avg(fExp,'pre','ans'), avg(fCtrl,'pre','ans')];
            charts.sexoAns.data.datasets[1].data = [avg(mExp,'post','ans'), avg(mCtrl,'post','ans'), avg(fExp,'post','ans'), avg(fCtrl,'post','ans')];
            charts.sexoAns.update();

            charts.sexoAtt.data.datasets[0].data = [avg(mExp,'pre','att'), avg(mCtrl,'pre','att'), avg(fExp,'pre','att'), avg(fCtrl,'pre','att')];
            charts.sexoAtt.data.datasets[1].data = [avg(mExp,'post','att'), avg(mCtrl,'post','att'), avg(fExp,'post','att'), avg(fCtrl,'post','att')];
            charts.sexoAtt.update();
        }

        function clearForm() {
            document.getElementById('codigo').value = '';
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = '');
            document.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = false);
            document.getElementById('observaciones').value = '';
            document.getElementById('exp_sino').value = 'No';
            document.getElementById('exp_freq').value = '';
            document.getElementById('exp_donde').value = '';
            document.getElementById('codigo').focus();
        }

        function editStudent(code) {
            const s = students.find(s => s.codigo === code);
            if(!s) return;
            document.getElementById('codigo').value = s.codigo;
            document.getElementById('grupo').value = s.grupo;
            document.getElementById('sexo').value = s.sexo;
            document.getElementById('edad').value = s.edad;
            
            const data = currentPhase === 'PRE' ? s.pre : s.post;
            if(data) {
                data.rawAns.forEach((v, i) => document.getElementById('a'+(i+1)).value = v);
                data.rawAtt.forEach((v, i) => document.getElementById('at'+(i+1)).value = v);
                document.getElementById('observaciones').value = data.obs || '';
                if(currentPhase === 'PRE' && data.dist) {
                    document.getElementById('d_comp').checked = data.dist.comp;
                    document.getElementById('d_ruido').checked = data.dist.ruido;
                    document.getElementById('d_cans').checked = data.dist.cans;
                    document.getElementById('d_preoc').checked = data.dist.preoc;
                    document.getElementById('d_aburr').checked = data.dist.aburr;
                    document.getElementById('d_olor').checked = data.dist.olor;
                    document.getElementById('exp_sino').value = data.exp.si;
                    document.getElementById('exp_freq').value = data.exp.freq;
                    document.getElementById('exp_donde').value = data.exp.donde;
                } else if (currentPhase === 'POST' && data.val) {
                    document.getElementById('val_ayuda').value = data.val.ayuda;
                    document.getElementById('val_sentido').value = data.val.sentido;
                    document.getElementById('val_facil').value = data.val.facil;
                    document.getElementById('val_futuro').value = data.val.futuro;
                }
                showMessage(`Editando ${currentPhase} de ${code}`, 'text-yellow-600');
            } else {
                showMessage(`Alumno ${code} existe, a√±ade datos de ${currentPhase}`, 'text-blue-600');
                document.querySelectorAll('input[type="number"]').forEach(i => i.value = '');
            }
        }

        function delStudent(code) {
            if(confirm('¬øBorrar alumno completo?')) {
                students = students.filter(s => s.codigo !== code);
                saveToLocal(); render();
            }
        }

        function exportToCSV() {
            let csv = "CODIGO,GRUPO,SEXO,EDAD,EXP_SI,EXP_FREQ,EXP_DONDE,PRE_ANS,POST_ANS,PRE_AT,POST_AT,VAL_AYUDA,VAL_NOTA,VAL_FUTURO\n";
            students.forEach(s => {
                const preA = s.pre ? s.pre.ans : '';
                const postA = s.post ? s.post.ans : '';
                const preAt = s.pre ? s.pre.att : '';
                const postAt = s.post ? s.post.att : '';
                const expSi = s.pre ? s.pre.exp.si : '';
                const expFreq = s.pre ? s.pre.exp.freq : '';
                const expDonde = s.pre ? s.pre.exp.donde : '';
                const v1 = s.post?.val?.ayuda || '';
                const v2 = s.post?.val?.sentido || '';
                const v3 = s.post?.val?.futuro || '';
                csv += `${s.codigo},${s.grupo},${s.sexo},${s.edad},${expSi},${expFreq},${expDonde},${preA},${postA},${preAt},${postAt},${v1},${v2},${v3}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "datos_completos_tfm.csv";
            link.click();
        }

        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(students));
            const link = document.createElement("a"); link.href = dataStr; link.download = "backup_tfm_v32.json"; link.click();
        }

        function loadBackupFile(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const raw = JSON.parse(e.target.result);
                    students = raw.map(s => {
                        if(s.pre || s.post) {
                            if (s.pre && !s.pre.exp) s.pre.exp = { si: 'No', freq: '', donde: '' };
                            return s; 
                        }
                        return { 
                            codigo: s.codigo, grupo: s.grupo, sexo: s.sexo, edad: s.edad,
                            pre: { ans: s.totalAnsiedad, att: s.totalAtencion, rawAns: s.rawAnsiedad, rawAtt: s.rawAtencion, dist: s.dist, exp: { si: s.expSiNo, freq: s.expFreq, donde: s.expDonde } },
                            post: null
                        };
                    });
                    saveToLocal(); render(); alert('Datos importados y actualizados a v32');
                } catch(err) { alert('Error al cargar'); }
            };
            reader.readAsText(file);
        }

        function saveToLocal() { localStorage.setItem('tfm_v32', JSON.stringify(students)); }
        function loadData() { const d = localStorage.getItem('tfm_v32') || localStorage.getItem('tfm_v31') || localStorage.getItem('tfm_v30') || localStorage.getItem('tfm_v29') || localStorage.getItem('tfm_v28') || localStorage.getItem('tfm_v27') || localStorage.getItem('tfm_v26') || localStorage.getItem('tfm_v25') || localStorage.getItem('tfm_v24') || localStorage.getItem('tfm_v23'); if(d) students = JSON.parse(d); }
        function wipeAll() { if(confirm('¬øBorrar todo?')) { students=[]; saveToLocal(); render(); } }
        function showMessage(txt, color) { const m = document.getElementById('msg'); m.innerText = txt; m.className = `text-center text-xs font-bold mt-2 h-4 ${color}`; setTimeout(()=>m.innerText='',3000); }

        function initCharts() {
            const commonOpts = { 
                responsive: true, 
                maintainAspectRatio: false, 
                layout: { padding: { top: 20 } },
                plugins: { 
                    legend: { position: 'bottom' },
                    datalabels: {
                        color: '#fff', 
                        anchor: 'center', 
                        align: 'center',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value) => value > 0 ? fmt(value) : '' 
                    }
                } 
            };

            charts.ans = new Chart(document.getElementById('chartCompAnsiedad'), { type: 'bar', data: { labels: ['Exp', 'Ctrl'], datasets: [{ label: 'Pre-Test', data:[0,0], backgroundColor: '#9ca3af' }, { label: 'Post-Test', data:[0,0], backgroundColor: '#22c55e' }] }, options: { ...commonOpts, plugins: { ...commonOpts.plugins, title: { display: true, text: 'Evoluci√≥n ANSIEDAD (Menos es mejor)' } } } });

            charts.att = new Chart(document.getElementById('chartCompAtencion'), { type: 'bar', data: { labels: ['Exp', 'Ctrl'], datasets: [{ label: 'Pre-Test', data:[0,0], backgroundColor: '#9ca3af' }, { label: 'Post-Test', data:[0,0], backgroundColor: '#3b82f6' }] }, options: { ...commonOpts, plugins: { ...commonOpts.plugins, title: { display: true, text: 'Evoluci√≥n ATENCI√ìN (M√°s es mejor)' } } } });

            const initBarOpts = JSON.parse(JSON.stringify(commonOpts));
            initBarOpts.plugins.datalabels.color = '#fff'; 
            charts.initBar = new Chart(document.getElementById('chartInitialBar'), { 
                type: 'bar', 
                data: { 
                    labels: ['Experimental', 'Control'], 
                    datasets: [
                        { label: 'Ansiedad Inicial', data:[0,0], backgroundColor: '#ef4444' }, 
                        { label: 'Atenci√≥n Inicial', data:[0,0], backgroundColor: '#3b82f6' } 
                    ] 
                }, 
                options: { ...initBarOpts, plugins: { ...initBarOpts.plugins, title: { display: true, text: 'Situaci√≥n Inicial (Pre-Test)' } } } 
            });

            // NUEVA GR√ÅFICA FINAL
            charts.finalBar = new Chart(document.getElementById('chartFinalBar'), { 
                type: 'bar', 
                data: { 
                    labels: ['Experimental', 'Control'], 
                    datasets: [
                        { label: 'Ansiedad Final', data:[0,0], backgroundColor: '#ef4444' }, 
                        { label: 'Atenci√≥n Final', data:[0,0], backgroundColor: '#3b82f6' } 
                    ] 
                }, 
                options: { ...initBarOpts, plugins: { ...initBarOpts.plugins, title: { display: true, text: 'Situaci√≥n Final (Post-Test)' } } } 
            });

            const distOpts = JSON.parse(JSON.stringify(commonOpts));
            distOpts.indexAxis = 'y';
            distOpts.plugins.datalabels.color = '#000'; 
            distOpts.plugins.datalabels.anchor = 'end';
            distOpts.plugins.datalabels.align = 'end';
            distOpts.layout.padding.right = 30; 
            charts.dist = new Chart(document.getElementById('chartDistractores'), { type: 'bar', data: { labels: ['Compa√±eros','Ruido','Cansancio','Preocup.','Aburrim.','Olor'], datasets: [{ label: 'Afectados', data:[0,0,0,0,0,0], backgroundColor: '#f87171' }] }, options: { ...distOpts, plugins: { ...distOpts.plugins, title: { display: true, text: 'Distractores (Pre-Test)' } } } });

            charts.sexoAns = new Chart(document.getElementById('chartSexoAnsiedad'), { type: 'bar', data: { labels: ['Chicos(E)', 'Chicos(C)', 'Chicas(E)', 'Chicas(C)'], datasets: [{ label: 'Pre', data:[], backgroundColor: '#fca5a5' }, { label: 'Post', data:[], backgroundColor: '#b91c1c' }] }, options: { ...commonOpts, plugins: { ...commonOpts.plugins, title: { display: true, text: 'Evoluci√≥n Ansiedad por Sexo' } } } });

            charts.sexoAtt = new Chart(document.getElementById('chartSexoAtencion'), { type: 'bar', data: { labels: ['Chicos(E)', 'Chicos(C)', 'Chicas(E)', 'Chicas(C)'], datasets: [{ label: 'Pre', data:[], backgroundColor: '#93c5fd' }, { label: 'Post', data:[], backgroundColor: '#1d4ed8' }] }, options: { ...commonOpts, plugins: { ...commonOpts.plugins, title: { display: true, text: 'Evoluci√≥n Atenci√≥n por Sexo' } } } });
        }
    </script>
</body>
</html>